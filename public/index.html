<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airlytics - Indian Cities Air Pollution Tracker</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="Websitelogo.jpeg">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <!-- Google Fonts - Playfair Display (Classic Serif) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/dashboard.css">
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#mainTabs" class="visually-hidden-focusable">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="z-index: 1030;">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" style="gap: 12px;">
                <img src="Websitelogo.jpeg" alt="Airlytics Logo" class="navbar-logo" style="width: 65px; height: 65px; border-radius: 50%; object-fit: cover; background: transparent; box-shadow: 0 4px 16px rgba(0,0,0,0.4);"> 
                <div>
                    <div class="brand-name" style="font-family: 'Playfair Display', 'Georgia', serif; font-size: 1.8rem; font-weight: 700; color: #fff; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">AIRLYTICS</div>
                    <small style="color: rgba(255, 255, 255, 0.85); font-size: 0.75rem; font-weight: 500; letter-spacing: 2px; text-transform: uppercase;">Air Quality Monitor</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                            <i class="bi bi-info-circle me-1"></i> About
                        </a>
                    </li>
                    <li class="nav-item" id="userProfileSection">
                        <!-- Will be populated by JavaScript -->
                    </li>
                    <li class="nav-item">
                        <button id="darkModeToggle" class="btn btn-outline-light ms-2" aria-label="Toggle dark mode">
                            <i class="bi bi-moon-stars"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Guest Limitations Popup (Left Side) -->
    <div id="guestLimitationsPopup" style="display: none; position: fixed; top: 80px; left: 20px; z-index: 1025; max-width: 350px;">
        <div class="card border-warning shadow-lg">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Guest Access Limitations</h6>
                <button type="button" class="btn-close btn-close-dark" onclick="document.getElementById('guestLimitationsPopup').style.display='none'"></button>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><span class="text-danger">❌</span> Cannot add custom cities from the map</li>
                    <li class="mb-2"><span class="text-danger">❌</span> Limited to viewing random city data only</li>
                    <li class="mb-2"><span class="text-danger">❌</span> Cannot access detailed city analysis</li>
                    <li class="mb-2"><span class="text-success">✅</span> Can view basic air quality data</li>
                    <li class="mb-0"><span class="text-success">✅</span> Access to health recommendations</li>
                </ul>
                <a href="/" class="btn btn-warning btn-sm w-100 mt-3">
                    <i class="bi bi-person-plus"></i> Register for Full Access
                </a>
            </div>
        </div>
    </div>

    <!-- Remove body padding since navbar is not fixed -->
    <style>
        .navbar-logo {
            transition: transform 0.3s ease;
        }
        .navbar-logo:hover {
            transform: scale(1.1);
        }
        #guestLimitationsPopup {
            position: fixed;
            top: 20px;
            left: 20px;
        }
    </style>

    <!-- Hero Section -->
<section class="hero-section">
    <div class="container hero-content">
        <div class="row justify-content-center text-center">
            <div class="col-lg-10">
                <h1 class="hero-title">Air Pollution Tracker</h1>
                <p class="hero-subtitle">Real-time monitoring and analysis of air quality across Indian cities</p>
                
                <!-- Quick Action Cards -->
                <div class="row justify-content-center g-4 mt-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card action-card h-100" onclick="document.getElementById('tracker-tab').click()" style="cursor: pointer;">
                            <div class="card-body text-center p-4">
                                <div class="action-icon bg-primary bg-opacity-10 text-primary rounded-circle p-3 mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-geo-alt fs-3"></i>
                                </div>
                                <h5 class="card-title mb-2">Track Cities</h5>
                                <p class="card-text small text-muted mb-0">Monitor real-time air quality data</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card action-card h-100" onclick="document.getElementById('map-tab').click()" style="cursor: pointer;">
                            <div class="card-body text-center p-4">
                                <div class="action-icon bg-success bg-opacity-10 text-success rounded-circle p-3 mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-map fs-3"></i>
                                </div>
                                <h5 class="card-title mb-2">Interactive Map</h5>
                                <p class="card-text small text-muted mb-0">Visualize pollution across India</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card action-card h-100" onclick="document.getElementById('analysis-tab').click()" style="cursor: pointer;">
                            <div class="card-body text-center p-4">
                                <div class="action-icon bg-warning bg-opacity-10 text-warning rounded-circle p-3 mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-graph-up fs-3"></i>
                                </div>
                                <h5 class="card-title mb-2">Data Analysis</h5>
                                <p class="card-text small text-muted mb-0">Compare and analyze cities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card action-card h-100" style="cursor: default;">
                            <div class="card-body text-center p-4">
                                <div class="action-icon bg-info bg-opacity-10 text-info rounded-circle p-3 mx-auto mb-3" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-database fs-3"></i>
                                </div>
                                <h5 class="card-title mb-2">Cities in Database</h5>
                                <h3 class="text-info mb-0" id="totalCitiesCount">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

    <!-- Main Content with Tabs -->
    <section class="py-5">
        <div class="container">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs justify-content-center mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tracker-tab" data-bs-toggle="tab" data-bs-target="#tracker" type="button" role="tab" aria-controls="tracker" aria-selected="true">
                        <i class="bi bi-geo-alt me-2"></i>Pollution Tracker
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#mapTab" type="button" role="tab" aria-controls="mapTab" aria-selected="false">
                        <i class="bi bi-map me-2"></i>Map View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="false">
                        <i class="bi bi-graph-up me-2"></i>City Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overallAnalysis" type="button" role="tab" aria-controls="overallAnalysis" aria-selected="false">
                        <i class="bi bi-bar-chart me-2"></i>Overall Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab" aria-controls="health" aria-selected="false">
                        <i class="bi bi-heart-pulse me-2"></i>Health Tips
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabsContent">
                <!-- Tracker Tab -->
                <div class="tab-pane fade show active" id="tracker" role="tabpanel" aria-labelledby="tracker-tab">
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8 text-center">
                            <!-- Tracked Cities Counter -->
                            <div class="alert alert-info d-inline-flex align-items-center mb-3" role="alert">
                                <i class="bi bi-pin-map-fill me-2 fs-5"></i>
                                <span>You are tracking <strong id="userTrackedCitiesCount">0</strong> <span id="cityText">cities</span></span>
                            </div>
                            <div class="btn-group mb-3 d-block" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="addRandomCity()">
                                    <i class="bi bi-plus-circle me-1"></i> Add Random City
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="refreshAllCitiesData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearAllCities()">
                                    <i class="bi bi-trash me-1"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cities Container with Enhanced Scroll -->
                    <div class="cities-container" id="citiesContainer">
                        <div class="city-grid" id="pollutionCards">
                            <!-- Cards will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="last-updated text-center mt-4" id="lastUpdated">
                        Last updated: <span id="updateTime">--:--:--</span>
                    </div>
                </div>

                <!-- Map Tab -->
                <div class="tab-pane fade" id="mapTab" role="tabpanel" aria-labelledby="map-tab">
                    <div class="position-relative">
                        <div id="map"></div>
                        <div class="map-controls" style="max-width: 300px;">
                            <div class="card">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2 fs-6">Search Location</h6>
                                    <div class="input-group input-group-sm">
                                        <input type="text" id="mapLocationInput" class="form-control form-control-sm" placeholder="Enter city..." aria-label="Search for a city">
                                        <button class="btn btn-primary btn-sm" onclick="searchMapLocation()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <div id="searchResult" class="mt-2" style="display: none;">
                                        <!-- Search result will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab - Single City Analysis -->
                <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
                    <div id="cityAnalysisHeader" class="city-analysis-header">
                        <h3 id="analysisCityName">Select a city from the tracker to view analysis</h3>
                    </div>

                    <div id="singleCityAnalysisContent" style="display: none;">
                        <!-- Health Impact Indicators -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="mb-3">Health Impact Indicators</h4>
                                <div id="healthImpactCard" class="health-card health-moderate">
                                    <h5 id="healthTitle">Today's air is Moderate - Sensitive people should consider reducing prolonged outdoor exertion.</h5>
                                    <p id="healthDescription">Air quality is acceptable for most people. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 3-Day Forecast for Selected City -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="mb-3">3-Day Forecast for <span id="forecastCityName"></span></h4>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row" id="forecastContainer">
                                            <!-- Forecast cards will be populated by JavaScript -->
                                        </div>
                                        <div id="forecastChartContainer" class="chart-container mt-3">
                                            <canvas id="forecastChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Single City Pollutant Insights -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="mb-3">Pollutant Breakdown</h4>
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Pollutant Concentration</h5>
                                        <div class="chart-container">
                                            <canvas id="cityPollutantChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Environmental Data for Selected City -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="mb-3">Environmental Data</h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Current Weather Conditions</h5>
                                                <div class="weather-card">
                                                    <i class="bi bi-thermometer-half weather-icon text-danger"></i>
                                                    <div>
                                                        <h6>Temperature</h6>
                                                        <p id="temperature">--°C</p>
                                                    </div>
                                                </div>
                                                <div class="weather-card">
                                                    <i class="bi bi-droplet weather-icon text-primary"></i>
                                                    <div>
                                                        <h6>Humidity</h6>
                                                        <p id="humidity">--%</p>
                                                    </div>
                                                </div>
                                                <div class="weather-card">
                                                    <i class="bi bi-wind weather-icon text-success"></i>
                                                    <div>
                                                        <h6>Wind Speed</h6>
                                                        <p id="windSpeed">-- km/h</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Historical Timeline</h5>
                                                <input type="range" class="form-range timeline-slider" id="timelineSlider" min="1" max="12" value="6">
                                                <div class="d-flex justify-content-between small">
                                                    <span>Jan</span>
                                                    <span>Jun</span>
                                                    <span>Dec</span>
                                                </div>
                                                <div class="chart-container mt-3">
                                                    <canvas id="timelineChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overall Analysis Tab - All Cities Comparison -->
                <div class="tab-pane fade" id="overallAnalysis" role="tabpanel" aria-labelledby="overall-tab">
                    <h3 class="mb-4">Overall Analysis - All Tracked Cities</h3>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div id="mostPollutedCard" class="highlight-box most-polluted">
                                <h5>Most Polluted City Today</h5>
                                <h3 id="mostPollutedCity">--</h3>
                                <p>AQI: <span id="mostPollutedAQI">--</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="leastPollutedCard" class="highlight-box least-polluted">
                                <h5>Least Polluted City Today</h5>
                                <h3 id="leastPollutedCity">--</h3>
                                <p>AQI: <span id="leastPollutedAQI">--</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- All Cities Pollutant Trends -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Pollutant Trends Across Cities</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>PM2.5 Trends</h6>
                                            <div class="mini-chart-container">
                                                <canvas id="pm25Chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>PM10 Trends</h6>
                                            <div class="mini-chart-container">
                                                <canvas id="pm10Chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>NO₂ Trends</h6>
                                            <div class="mini-chart-container">
                                                <canvas id="no2Chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>O₃ Trends</h6>
                                            <div class="mini-chart-container">
                                                <canvas id="o3Chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- City Comparison -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Compare Cities</h4>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-5">
                                            <select id="city1Select" class="form-select" aria-label="Select first city">
                                                <option value="">Select first city</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <select id="city2Select" class="form-select" aria-label="Select second city">
                                                <option value="">Select second city</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" onclick="compareCities()">Compare</button>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="cityComparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pollution-Weather Correlation -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Pollution-Weather Correlation</h4>
                            <div class="card">
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="correlationChart"></canvas>
                                    </div>
                                    <p class="mt-2"><strong>Insight:</strong> Higher humidity tends to increase PM2.5 levels across all cities.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Features - PDF and Alerts -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Download Report</h5>
                                    <p>Download a comprehensive report of current air quality analysis for all tracked cities.</p>
                                    <button class="btn btn-primary" onclick="downloadReport()">
                                        <i class="bi bi-download me-2"></i>Download PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">AQI Alerts</h5>
                                    <div id="aqiAlert" class="alert-card alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <span id="alertText">Your city AQI crossed 150 (Unhealthy).</span>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="alertToggle" checked>
                                        <label class="form-check-label" for="alertToggle">Enable AQI alerts</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health Tips Tab -->
                <div class="tab-pane fade" id="health" role="tabpanel" aria-labelledby="health-tab">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Health Recommendations by AQI Level</h4>
                            <div class="accordion" id="healthAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingGood">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGood" aria-expanded="true" aria-controls="collapseGood">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-good text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">0-50</span>
                                                Good (Green)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseGood" class="accordion-collapse collapse show" aria-labelledby="headingGood" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Air quality is satisfactory, and air pollution poses little or no risk.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Enjoy outdoor activities</li>
                                                <li>Open windows to allow fresh air circulation</li>
                                                <li>Ideal for outdoor exercise and activities</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingModerate">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModerate" aria-expanded="false" aria-controls="collapseModerate">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-moderate text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">51-100</span>
                                                Moderate (Yellow)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseModerate" class="accordion-collapse collapse" aria-labelledby="headingModerate" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Air quality is acceptable. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Sensitive individuals should consider reducing prolonged outdoor exertion</li>
                                                <li>Generally acceptable for most individuals</li>
                                                <li>Monitor symptoms if you have respiratory conditions</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingUnhealthySensitive">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnhealthySensitive" aria-expanded="false" aria-controls="collapseUnhealthySensitive">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-unhealthy-sensitive text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">101-150</span>
                                                Unhealthy for Sensitive Groups (Orange)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseUnhealthySensitive" class="accordion-collapse collapse" aria-labelledby="headingUnhealthySensitive" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Members of sensitive groups may experience health effects. The general public is less likely to be affected.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Children, elderly, and people with respiratory diseases should limit outdoor activities</li>
                                                <li>Consider wearing a mask when going outside</li>
                                                <li>Keep windows closed during peak pollution hours</li>
                                                <li>Use air purifiers indoors if available</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingUnhealthy">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnhealthy" aria-expanded="false" aria-controls="collapseUnhealthy">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-unhealthy text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">151-200</span>
                                                Unhealthy (Red)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseUnhealthy" class="accordion-collapse collapse" aria-labelledby="headingUnhealthy" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Limit outdoor activities</li>
                                                <li>Wear N95 masks when going outside</li>
                                                <li>Keep windows closed and use air purifiers</li>
                                                <li>Avoid strenuous outdoor exercise</li>
                                                <li>People with heart or lung disease should follow their doctors' advice</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingVeryUnhealthy">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVeryUnhealthy" aria-expanded="false" aria-controls="collapseVeryUnhealthy">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-very-unhealthy text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">201-300</span>
                                                Very Unhealthy (Purple)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseVeryUnhealthy" class="accordion-collapse collapse" aria-labelledby="headingVeryUnhealthy" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Health warnings of emergency conditions. Everyone is likely to be affected.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Avoid all outdoor activities</li>
                                                <li>Stay indoors with windows and doors closed</li>
                                                <li>Use high-efficiency air purifiers</li>
                                                <li>If you must go outside, wear a high-quality mask</li>
                                                <li>People with heart or lung disease should remain indoors and avoid physical exertion</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingHazardous">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHazardous" aria-expanded="false" aria-controls="collapseHazardous">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-hazardous text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">301+</span>
                                                Hazardous (Maroon)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseHazardous" class="accordion-collapse collapse" aria-labelledby="headingHazardous" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Health alert: everyone may experience serious health effects.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Avoid all outdoor activities</li>
                                                <li>Remain indoors with windows and doors closed</li>
                                                <li>Use high-efficiency air purifiers</li>
                                                <li>Avoid physical exertion</li>
                                                <li>People with heart or lung disease should remain indoors and seek medical attention if symptoms worsen</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About Airlytics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5>Air Pollution Tracker for Indian Cities</h5>
                    <p>Airlytics is a comprehensive air quality monitoring platform designed specifically for Indian cities. Our mission is to provide real-time, accurate air pollution data to help citizens make informed decisions about their daily activities and health.</p>
                    
                    <h6>Features:</h6>
                    <ul>
                        <li>Real-time AQI monitoring for major Indian cities</li>
                        <li>Interactive pollution maps</li>
                        <li>Detailed pollutant analysis</li>
                        <li>Health recommendations based on air quality</li>
                        <li>Historical data and trends</li>
                        <li>Weather correlation analysis</li>
                    </ul>
                    
                    <h6>Data Sources:</h6>
                    <p>We aggregate data from multiple reliable sources including government monitoring stations, satellite imagery, and validated crowd-sourced data to ensure accuracy and comprehensiveness.</p>
                    
                    <h6>Technology:</h6>
                    <p>Built with modern web technologies including Node.js, Express, PostgreSQL, and advanced data visualization libraries to provide a seamless user experience across devices.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Guest Features - Load first -->
    <script src="/js/guestFeatures.js"></script>
    
    <!-- Cities Data -->
    <script type="module">
        import { indianCitiesData } from './data/cities.js';
        window.indianCitiesData = indianCitiesData;
    </script>
    
    <!-- Custom JavaScript -->
    <script>
        // Wait for cities data to load
        let citiesData = [];
        
        // Poll for cities data
        const waitForCitiesData = setInterval(() => {
            if (window.indianCitiesData) {
                citiesData = window.indianCitiesData;
                clearInterval(waitForCitiesData);
            }
        }, 100);
        
        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            const userType = localStorage.getItem('userType');
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            // If no authentication data, redirect to landing page
            if (!userType && !user && !token) {
                window.location.href = '/';
                return;
            }
            
            // If authentication data exists, verify it's valid
            if (token) {
                try {
                    // Check if token is expired
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentTime = Date.now() / 1000;
                    
                    if (payload.exp < currentTime) {
                        // Token expired, clear data and redirect
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userType');
                        window.location.href = '/';
                        return;
                    }
                } catch (e) {
                    // Invalid token, clear data and redirect
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('userType');
                    window.location.href = '/';
                    return;
                }
            }
            
            // Populate user profile section if authenticated
            const userProfileSection = document.getElementById('userProfileSection');
            if (user) {
                const userData = JSON.parse(user);
                userProfileSection.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i> ${userData.name}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </div>
                `;
            } else if (userType === 'guest') {
                userProfileSection.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i> Guest User
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </div>
                `;
                
                // Initialize guest restrictions
                if (typeof setupGuestRestrictions === 'function') {
                    setupGuestRestrictions();
                }
            }
        });
        
        // Logout function
        function logout() {
            // Clear authentication data
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('userType');
            
            // Redirect to landing page
            window.location.href = '/';
        }
        
        // Fetch with authentication
        function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            
            return fetch(url, options);
        }
        
        // Notification function
        function showNotification(message, type = 'info') {
            // Create a toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-dismiss after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Initialize map
        let map;
        let markers = [];
        
        function initMap() {
            // Check if map already exists
            if (map) {
                try {
                    map.invalidateSize();
                } catch (e) {
                    console.error('Error invalidating map size:', e);
                }
                return;
            }
            
            try {
                console.log('Initializing map...');
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    console.error('Leaflet library not loaded');
                    return;
                }
                
                // Check if map container exists
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error('Map container not found');
                    return;
                }
                
                // Initialize map
                map = L.map('map').setView([20.5937, 78.9629], 5);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(map);
                
                console.log('Map tiles added');
                
                // Wait a bit for cities data to be available
                setTimeout(() => {
                    // Add markers for all cities from cities.js
                    const cities = citiesData.length > 0 ? citiesData : window.indianCitiesData || [];
                    
                    console.log('Adding markers for', cities.length, 'cities');
                    
                    if (cities.length > 0) {
                        cities.forEach(city => {
                            const marker = L.marker([city.lat, city.lon]).addTo(map);
                            marker.bindPopup(`
                                <div style="text-align: center; padding: 5px;">
                                    <strong>${city.name}</strong><br>
                                    AQI: <span style="color: ${getAQIColor(city.aqi)}; font-weight: bold;">${city.aqi}</span><br>
                                    <button onclick="addCityFromMap('${city.name}')" class="btn btn-sm btn-primary mt-2" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                        Add to Tracker
                                    </button>
                                </div>
                            `);
                            markers.push(marker);
                        });
                        console.log('Added', markers.length, 'markers to map');
                    }
                }, 500);
                
                // Map click event removed - users should search for cities instead
                
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }
        
        // Get AQI color helper function
        function getAQIColor(aqi) {
            if (aqi <= 50) return '#00e400';
            if (aqi <= 100) return '#ffff00';
            if (aqi <= 150) return '#ff7e00';
            if (aqi <= 200) return '#ff0000';
            if (aqi <= 300) return '#8f3f97';
            return '#7e0023';
        }
        
        // Add city from map
        function addCityFromMap(cityName) {
            // Check if user is a guest
            const userType = localStorage.getItem('userType');
            if (userType === 'guest') {
                showNotification('Guest users cannot add cities from the map. Please register for this feature.', 'warning');
                if (typeof showGuestRestrictionModal === 'function') {
                    showGuestRestrictionModal('adding cities from the map');
                }
                return;
            }
            
            const cities = citiesData.length > 0 ? citiesData : window.indianCitiesData || [];
            const city = cities.find(c => c.name === cityName);
            
            if (city) {
                addCityToTracker({
                    name: city.name,
                    lat: city.lat,
                    lng: city.lon,
                    aqi: city.aqi,
                    pm25: city.pm25,
                    pm10: city.pm10,
                    no2: city.no2,
                    so2: city.so2,
                    co: city.co,
                    o3: city.o3
                });
            }
        }
        
        // Add city to tracker
        function addCityToTracker(city) {
            // Get existing cities or initialize empty array
            let cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            
            // Check if city already exists
            const existingCity = cities.find(c => c.name === city.name);
            if (existingCity) {
                alert('City already in tracker!');
                return;
            }
            
            // Add new city
            cities.push(city);
            
            // Save to localStorage
            localStorage.setItem('trackedCities', JSON.stringify(cities));
            
            // Refresh the display
            displayTrackedCities();
            
            // Update analysis charts if the analysis tab is currently active
            const analysisTab = document.getElementById('analysis');
            if (analysisTab && analysisTab.classList.contains('active')) {
                initializeAnalysisCharts();
            }
        }
        
        // Display tracked cities
        function displayTrackedCities() {
            const citiesContainer = document.getElementById('pollutionCards');
            let cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            
            // Update user tracked cities count
            updateUserTrackedCitiesCount(cities.length);
            
            // Populate city selectors for analysis tabs
            populateCitySelectors();
            
            citiesContainer.innerHTML = '';
            
            if (cities.length === 0) {
                citiesContainer.innerHTML = '<p class="text-center text-muted">No cities tracked yet. Click "Add Random City" to start tracking.</p>';
                return;
            }
            
            cities.forEach(city => {
                const cityCard = document.createElement('div');
                cityCard.className = 'city-card';
                
                // Determine AQI level and color
                let aqiLevel, aqiColor;
                if (city.aqi <= 50) {
                    aqiLevel = 'Good';
                    aqiColor = 'success';
                } else if (city.aqi <= 100) {
                    aqiLevel = 'Moderate';
                    aqiColor = 'warning';
                } else if (city.aqi <= 150) {
                    aqiLevel = 'Unhealthy for Sensitive Groups';
                    aqiColor = 'warning';
                } else if (city.aqi <= 200) {
                    aqiLevel = 'Unhealthy';
                    aqiColor = 'danger';
                } else if (city.aqi <= 300) {
                    aqiLevel = 'Very Unhealthy';
                    aqiColor = 'danger';
                } else {
                    aqiLevel = 'Hazardous';
                    aqiColor = 'danger';
                }
                
                cityCard.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title">${city.name}</h5>
                                </div>
                                <div class="text-end">
                                    <div class="fs-2 fw-bold text-${aqiColor}">${city.aqi}</div>
                                    <div class="small text-${aqiColor}">${aqiLevel}</div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row text-center g-1 mb-2">
                                <div class="col-4">
                                    <div class="pollutant-value">${city.pm25.toFixed(1)}</div>
                                    <div class="pollutant-label">PM2.5</div>
                                </div>
                                <div class="col-4">
                                    <div class="pollutant-value">${city.pm10.toFixed(1)}</div>
                                    <div class="pollutant-label">PM10</div>
                                </div>
                                <div class="col-4">
                                    <div class="pollutant-value">${city.no2.toFixed(1)}</div>
                                    <div class="pollutant-label">NO₂</div>
                                </div>
                            </div>
                            
                            <div class="row text-center g-1 mb-2">
                                <div class="col-4">
                                    <div class="pollutant-value">${city.so2.toFixed(1)}</div>
                                    <div class="pollutant-label">SO₂</div>
                                </div>
                                <div class="col-4">
                                    <div class="pollutant-value">${city.co.toFixed(1)}</div>
                                    <div class="pollutant-label">CO</div>
                                </div>
                                <div class="col-4">
                                    <div class="pollutant-value">${city.o3.toFixed(1)}</div>
                                    <div class="pollutant-label">O₃</div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewCityDetails('${city.name}')">
                                    <i class="bi bi-eye"></i> Details
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeCity('${city.name}')">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                citiesContainer.appendChild(cityCard);
            });
            
            // Update last updated time
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        }
        
        // Add random city
        async function addRandomCity() {
            const userType = localStorage.getItem('userType');
            
            // For guest users, use the guest API
            if (userType === 'guest') {
                try {
                    const response = await fetch('/api/guest/random-city', {
                        headers: {
                            'User-Type': 'guest',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch random city');
                    }
                    
                    const data = await response.json();
                    if (data.success && data.city) {
                        // Display guest city with limited data
                        displayGuestCity(data.city);
                        showNotification('Random city loaded', 'success');
                    }
                } catch (error) {
                    console.error('Error adding random city for guest:', error);
                    showNotification('Error loading city data', 'error');
                }
                return;
            }
            
            // For authenticated users, use the imported cities data
            const cities = citiesData.length > 0 ? citiesData : window.indianCitiesData || [];
            
            if (cities.length === 0) {
                alert('Cities data not loaded yet. Please try again.');
                return;
            }
            
            const randomCity = cities[Math.floor(Math.random() * cities.length)];
            
            addCityToTracker({
                name: randomCity.name,
                lat: randomCity.lat,
                lng: randomCity.lon,
                aqi: randomCity.aqi,
                pm25: randomCity.pm25,
                pm10: randomCity.pm10,
                no2: randomCity.no2,
                so2: randomCity.so2,
                co: randomCity.co,
                o3: randomCity.o3
            });
            
            // Update analysis charts if the analysis tab is currently active
            const analysisTab = document.getElementById('analysis');
            if (analysisTab && analysisTab.classList.contains('active')) {
                initializeAnalysisCharts();
            }
        }
        
        // Display guest city (called from guestFeatures.js)
        function displayGuestCity(city) {
            const pollutionCards = document.getElementById('pollutionCards');
            if (!pollutionCards) return;
            
            // Use the function from guestFeatures.js if available
            if (typeof window.createGuestCityCard === 'function') {
                const card = window.createGuestCityCard(city);
                pollutionCards.innerHTML = '';
                pollutionCards.appendChild(card);
            } else {
                // Fallback implementation
                pollutionCards.innerHTML = `
                    <div class="city-card mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">${city.name}</h5>
                                <p class="card-text">
                                    <strong>AQI:</strong> ${city.aqi}<br>
                                    <strong>PM2.5:</strong> ${city.pm25 || 'N/A'}<br>
                                    <strong>PM10:</strong> ${city.pm10 || 'N/A'}
                                </p>
                                <div class="alert alert-info py-2">
                                    <small>Guest users see basic air quality data only.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Update counter
            const trackedCount = document.getElementById('userTrackedCitiesCount');
            if (trackedCount) {
                trackedCount.textContent = '1';
            }
        }
        
        // Remove city
        function removeCity(cityName) {
            let cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            cities = cities.filter(city => city.name !== cityName);
            localStorage.setItem('trackedCities', JSON.stringify(cities));
            displayTrackedCities();
            
            // Update analysis charts if the analysis tab is currently active
            const analysisTab = document.getElementById('analysis');
            if (analysisTab && analysisTab.classList.contains('active')) {
                initializeAnalysisCharts();
            }
        }
        
        // Clear all cities
        function clearAllCities() {
            if (confirm('Are you sure you want to remove all tracked cities?')) {
                localStorage.removeItem('trackedCities');
                displayTrackedCities();
                
                // Update analysis charts if the analysis tab is currently active
                const analysisTab = document.getElementById('analysis');
                if (analysisTab && analysisTab.classList.contains('active')) {
                    initializeAnalysisCharts();
                }
            }
        }
        
        // Refresh all cities data
        function refreshAllCitiesData() {
            let cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            
            cities = cities.map(city => ({
                ...city,
                aqi: Math.floor(Math.random() * 300) + 50,
                pm25: Math.floor(Math.random() * 100) + 20,
                pm10: Math.floor(Math.random() * 150) + 30,
                no2: Math.floor(Math.random() * 80) + 10,
                so2: Math.floor(Math.random() * 60) + 5,
                co: Math.floor(Math.random() * 10) + 1,
                o3: Math.floor(Math.random() * 120) + 20
            }));
            
            localStorage.setItem('trackedCities', JSON.stringify(cities));
            displayTrackedCities();
            
            // Save historical data for forecast
            saveHistoricalData();
            
            // Update analysis charts if the analysis tab is currently active
            const analysisTab = document.getElementById('analysis');
            if (analysisTab && analysisTab.classList.contains('active')) {
                initializeAnalysisCharts();
                initializeForecast();
            }
        }
        
        // View city details - Opens City Analysis tab with selected city
        function viewCityDetails(cityName) {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city = cities.find(c => c.name === cityName);
            
            if (city) {
                // Switch to analysis tab
                document.getElementById('analysis-tab').click();
                
                // Load analysis for this city
                loadSingleCityAnalysis(cityName);
            }
        }
                    healthDescription = "Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.";
        // View city details - Opens City Analysis tab with selected city
        function viewCityDetails(cityName) {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city = cities.find(c => c.name === cityName);
            
            if (city) {
                // Switch to analysis tab
                document.getElementById('analysis-tab').click();
                
                // Load analysis for this city
                loadSingleCityAnalysis(cityName);
            }
        }
        
        // Show all cities analysis (no longer needed but kept for compatibility)
        function showAllCitiesAnalysis() {
            // Switch to overall analysis tab instead
            document.getElementById('overall-tab').click();
        }
        
        // Search map location
        function searchMapLocation() {
            const locationInput = document.getElementById('mapLocationInput');
            const locationName = locationInput.value.trim();
            const searchResult = document.getElementById('searchResult');
            
            if (!locationName) {
                alert('Please enter a city name');
                return;
            }
            
            // Use the imported cities data
            const cities = citiesData.length > 0 ? citiesData : window.indianCitiesData || [];
            
            const city = cities.find(c => c.name.toLowerCase() === locationName.toLowerCase());
            
            if (city) {
                map.setView([city.lat, city.lon], 10);
                
                // Add marker
                const marker = L.marker([city.lat, city.lon]).addTo(map)
                    .bindPopup(`<b>${city.name}</b>`)
                    .openPopup();
                markers.push(marker);
                
                // Show add to tracker button
                searchResult.innerHTML = `
                    <div class="alert alert-success p-2 mb-0">
                        <small><strong>${city.name}</strong> found!</small>
                        <button class="btn btn-sm btn-primary w-100 mt-2" onclick="addCityFromMap('${city.name}')">
                            <i class="bi bi-plus-circle me-1"></i>Add to Tracker
                        </button>
                    </div>
                `;
                searchResult.style.display = 'block';
            } else {
                searchResult.innerHTML = `
                    <div class="alert alert-warning p-2 mb-0">
                        <small>City not found. Please try another city.</small>
                    </div>
                `;
                searchResult.style.display = 'block';
            }
        }
        
        // Download report
        function downloadReport() {
            alert('Report download feature would be implemented here. In a real application, this would generate a PDF report.');
        }
        
        // Load single city analysis
        function loadSingleCityAnalysis(cityName) {
            const analysisContent = document.getElementById('singleCityAnalysisContent');
            
            if (!cityName) {
                analysisContent.style.display = 'none';
                return;
            }
            
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city = cities.find(c => c.name === cityName);
            
            if (!city) {
                alert('City not found');
                return;
            }
            
            // Show analysis content
            analysisContent.style.display = 'block';
            
            // Update city name in forecast
            document.getElementById('forecastCityName').textContent = cityName;
            document.getElementById('analysisCityName').textContent = `${cityName} Analysis`;
            
            // Update health impact for this city
            updateHealthImpact(city.aqi);
            
            // Generate 3-day forecast for this city
            generate3DayForecast(city);
            
            // Update pollutant chart for this city
            updateCityPollutantChart(city);
            
            // Update environmental data
            updateEnvironmentalData(city);
        }
        
        // Update health impact based on AQI
        function updateHealthImpact(aqi) {
            const healthCard = document.getElementById('healthImpactCard');
            const healthTitle = document.getElementById('healthTitle');
            const healthDescription = document.getElementById('healthDescription');
            
            if (aqi <= 50) {
                healthCard.className = 'health-card health-good';
                healthTitle.textContent = "Today's air is Good - Air quality is satisfactory.";
                healthDescription.textContent = "Air quality is ideal for most activities. Enjoy outdoor time!";
            } else if (aqi <= 100) {
                healthCard.className = 'health-card health-moderate';
                healthTitle.textContent = "Today's air is Moderate - Sensitive people should consider reducing prolonged outdoor exertion.";
                healthDescription.textContent = "Air quality is acceptable for most people. However, unusually sensitive people should consider reducing prolonged outdoor activities.";
            } else if (aqi <= 150) {
                healthCard.className = 'health-card health-unhealthy-sensitive';
                healthTitle.textContent = "Unhealthy for Sensitive Groups - People with respiratory conditions should limit outdoor activities.";
                healthDescription.textContent = "Members of sensitive groups may experience health effects. The general public is less likely to be affected.";
            } else if (aqi <= 200) {
                healthCard.className = 'health-card health-unhealthy';
                healthTitle.textContent = "Unhealthy - Everyone may experience health effects.";
                healthDescription.textContent = "Some members of the general public may experience health effects; members of sensitive groups may experience more serious health effects.";
            } else if (aqi <= 300) {
                healthCard.className = 'health-card health-very-unhealthy';
                healthTitle.textContent = "Very Unhealthy - Health alert: everyone may experience serious health effects.";
                healthDescription.textContent = "Health warnings of emergency conditions. The entire population is more likely to be affected.";
            } else {
                healthCard.className = 'health-card health-hazardous';
                healthTitle.textContent = "Hazardous - Health warning of emergency conditions.";
                healthDescription.textContent = "Everyone is more likely to be affected. Avoid all outdoor activities.";
            }
        }
        
        // Generate 3-day forecast for a city
        function generate3DayForecast(city) {
            const forecastContainer = document.getElementById('forecastContainer');
            forecastContainer.innerHTML = '';
            
            const days = ['Tomorrow', 'Day 2', 'Day 3'];
            const forecastData = [];
            
            for (let i = 0; i < 3; i++) {
                const variation = (Math.random() - 0.5) * 40;
                const forecastAQI = Math.max(50, Math.min(300, city.aqi + variation));
                forecastData.push(Math.round(forecastAQI));
                
                let aqiColor;
                if (forecastAQI <= 50) aqiColor = 'success';
                else if (forecastAQI <= 100) aqiColor = 'warning';
                else if (forecastAQI <= 150) aqiColor = 'orange';
                else aqiColor = 'danger';
                
                const forecastCard = `
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>${days[i]}</h6>
                                <div class="fs-3 fw-bold text-${aqiColor}">${Math.round(forecastAQI)}</div>
                                <small class="text-muted">AQI</small>
                            </div>
                        </div>
                    </div>
                `;
                forecastContainer.innerHTML += forecastCard;
            }
            
            // Update forecast chart
            updateForecastChart([city.aqi, ...forecastData]);
        }
        
        // Update forecast chart
        function updateForecastChart(data) {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;
            
            if (chartInstances['forecastChart']) {
                chartInstances['forecastChart'].destroy();
            }
            
            chartInstances['forecastChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Today', 'Tomorrow', 'Day 2', 'Day 3'],
                    datasets: [{
                        label: 'AQI Forecast',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update city pollutant chart
        function updateCityPollutantChart(city) {
            const ctx = document.getElementById('cityPollutantChart');
            if (!ctx) return;
            
            if (chartInstances['cityPollutantChart']) {
                chartInstances['cityPollutantChart'].destroy();
            }
            
            chartInstances['cityPollutantChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['PM2.5', 'PM10', 'NO₂', 'SO₂', 'CO', 'O₃'],
                    datasets: [{
                        label: 'Concentration',
                        data: [city.pm25, city.pm10, city.no2, city.so2, city.co, city.o3],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#00f2fe',
                            '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Update environmental data
        function updateEnvironmentalData(city) {
            // Simulate environmental data
            document.getElementById('temperature').textContent = (20 + Math.random() * 15).toFixed(1) + '°C';
            document.getElementById('humidity').textContent = (40 + Math.random() * 40).toFixed(0) + '%';
            document.getElementById('windSpeed').textContent = (5 + Math.random() * 20).toFixed(1) + ' km/h';
        }
        
        // Populate city selectors
        function populateCitySelectors() {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const singleCitySelect = document.getElementById('singleCitySelect');
            const city1Select = document.getElementById('city1Select');
            const city2Select = document.getElementById('city2Select');
            
            if (singleCitySelect) {
                singleCitySelect.innerHTML = '<option value="">Select a city to analyze...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
        // Populate city selectors
        function populateCitySelectors() {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city1Select = document.getElementById('city1Select');
            const city2Select = document.getElementById('city2Select');
            
            // Only populate city comparison selectors (removed singleCitySelect)
            if (city1Select) {
                city1Select.innerHTML = '<option value="">Select first city</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    city1Select.appendChild(option);
                });
            }
            
            if (city2Select) {
                city2Select.innerHTML = '<option value="">Select second city</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    city2Select.appendChild(option);
                });
            }
        }
        
        // Initialize analysis charts
        let chartInstances = {};
        
        function initializeAnalysisCharts() {
            console.log('🔍 Initializing Analysis Charts...');
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            console.log('📊 Tracked cities:', cities.length, cities);
            
            // Destroy existing charts
            Object.keys(chartInstances).forEach(key => {
                if (chartInstances[key]) {
                    console.log('🗑️ Destroying chart:', key);
                    chartInstances[key].destroy();
                }
            });
            chartInstances = {};
            
            if (cities.length === 0) {
                console.log('⚠️ No cities tracked, showing empty state');
                // Show message when no cities are tracked
                document.getElementById('mostPollutedCity').textContent = 'No data';
                document.getElementById('mostPollutedAQI').textContent = '--';
                document.getElementById('leastPollutedCity').textContent = 'No data';
                document.getElementById('leastPollutedAQI').textContent = '--';
                
                // Show a message in the chart area
                const chartContainers = ['pm25Chart', 'pm10Chart', 'no2Chart', 'o3Chart'];
                chartContainers.forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#6c757d';
                        ctx.textAlign = 'center';
                        ctx.fillText('Add cities to see charts', canvas.width / 2, canvas.height / 2);
                    }
                });
                return;
            }
            
            console.log('✅ Cities data available, creating charts...');
            
            // Find most and least polluted cities
            const mostPolluted = cities.reduce((prev, current) => 
                (prev.aqi > current.aqi) ? prev : current
            );
            const leastPolluted = cities.reduce((prev, current) => 
                (prev.aqi < current.aqi) ? prev : current
            );
            
            document.getElementById('mostPollutedCity').textContent = mostPolluted.name;
            document.getElementById('mostPollutedAQI').textContent = mostPolluted.aqi;
            document.getElementById('leastPollutedCity').textContent = leastPolluted.name;
            document.getElementById('leastPollutedAQI').textContent = leastPolluted.aqi;
            
            // Initialize PM2.5 chart
            const pm25Ctx = document.getElementById('pm25Chart');
            console.log('📈 Creating PM2.5 chart, canvas found:', !!pm25Ctx);
            if (pm25Ctx) {
                chartInstances.pm25 = new Chart(pm25Ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cities.map(c => c.name),
                        datasets: [{
                            label: 'PM2.5 (µg/m³)',
                            data: cities.map(c => c.pm25),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'µg/m³'
                                }
                            }
                        }
                    }
                });
                console.log('✅ PM2.5 chart created');
            }
            
            // Initialize PM10 chart
            const pm10Ctx = document.getElementById('pm10Chart');
            console.log('📈 Creating PM10 chart, canvas found:', !!pm10Ctx);
            if (pm10Ctx) {
                chartInstances.pm10 = new Chart(pm10Ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cities.map(c => c.name),
                        datasets: [{
                            label: 'PM10 (µg/m³)',
                            data: cities.map(c => c.pm10),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'µg/m³'
                                }
                            }
                        }
                    }
                });
                console.log('✅ PM10 chart created');
            }
            
            // Initialize NO2 chart
            const no2Ctx = document.getElementById('no2Chart');
            console.log('📈 Creating NO2 chart, canvas found:', !!no2Ctx);
            if (no2Ctx) {
                chartInstances.no2 = new Chart(no2Ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cities.map(c => c.name),
                        datasets: [{
                            label: 'NO₂ (µg/m³)',
                            data: cities.map(c => c.no2),
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            borderColor: 'rgb(255, 206, 86)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'µg/m³'
                                }
                            }
                        }
                    }
                });
                console.log('✅ NO2 chart created');
            }
            
            // Initialize O3 chart
            const o3Ctx = document.getElementById('o3Chart');
            console.log('📈 Creating O3 chart, canvas found:', !!o3Ctx);
            if (o3Ctx) {
                chartInstances.o3 = new Chart(o3Ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cities.map(c => c.name),
                        datasets: [{
                            label: 'O₃ (µg/m³)',
                            data: cities.map(c => c.o3),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'µg/m³'
                                }
                            }
                        }
                    }
                });
                console.log('✅ O3 chart created');
            }
            
            console.log('🎉 All charts initialization complete!');
            
            // Force chart updates after a short delay to ensure rendering
            setTimeout(() => {
                console.log('🔄 Forcing chart visibility...');
                
                // Make sure all canvas elements are visible
                ['pm25Chart', 'pm10Chart', 'no2Chart', 'o3Chart'].forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const container = canvas.parentElement;
                        if (container) {
                            container.style.display = 'block';
                            container.style.width = '100%';
                            container.style.height = '300px';
                        }
                        canvas.style.display = 'block';
                        canvas.style.width = '100%';
                        canvas.style.height = '280px';
                        console.log(`📐 Canvas ${id} - width: ${canvas.offsetWidth}px, height: ${canvas.offsetHeight}px`);
                    }
                });
                
                // Update and resize all charts
                Object.entries(chartInstances).forEach(([key, chart]) => {
                    if (chart && chart.update) {
                        chart.update('resize');
                        chart.resize();
                        console.log(`✅ Chart ${key} updated`);
                    }
                });
                console.log('🔄 Charts updated and resized');
            }, 200);
            
            // Populate city comparison dropdowns
            populateCitySelects();
        }
        
        // Populate city comparison dropdowns
        function populateCitySelects() {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city1Select = document.getElementById('city1Select');
            const city2Select = document.getElementById('city2Select');
            
            if (!city1Select || !city2Select) return;
            
            // Clear existing options except the first one
            city1Select.innerHTML = '<option value="">Select first city</option>';
            city2Select.innerHTML = '<option value="">Select second city</option>';
            
            // Add cities to both dropdowns
            cities.forEach(city => {
                const option1 = document.createElement('option');
                option1.value = city.name;
                option1.textContent = `${city.name} (AQI: ${city.aqi})`;
                city1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = city.name;
                option2.textContent = `${city.name} (AQI: ${city.aqi})`;
                city2Select.appendChild(option2);
            });
        }
        
        // Compare two cities
        let cityComparisonChartInstance = null;
        
        function compareCities() {
            const city1Name = document.getElementById('city1Select').value;
            const city2Name = document.getElementById('city2Select').value;
            
            if (!city1Name || !city2Name) {
                alert('Please select both cities to compare');
                return;
            }
            
            if (city1Name === city2Name) {
                alert('Please select different cities to compare');
                return;
            }
            
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city1 = cities.find(c => c.name === city1Name);
            const city2 = cities.find(c => c.name === city2Name);
            
            if (!city1 || !city2) {
                alert('Selected cities not found');
                return;
            }
            
            // Create comparison chart
            const ctx = document.getElementById('cityComparisonChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (cityComparisonChartInstance) {
                cityComparisonChartInstance.destroy();
            }
            
            cityComparisonChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['AQI', 'PM2.5', 'PM10', 'NO₂', 'SO₂', 'CO', 'O₃'],
                    datasets: [{
                        label: city1.name,
                        data: [city1.aqi, city1.pm25, city1.pm10, city1.no2, city1.so2, city1.co, city1.o3],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2
                    }, {
                        label: city2.name,
                        data: [city2.aqi, city2.pm25, city2.pm10, city2.no2, city2.so2, city2.co, city2.o3],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `${city1.name} vs ${city2.name} - Pollutant Comparison`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentration (µg/m³ / AQI)'
                            }
                        }
                    }
                }
            });
            
            console.log('✅ City comparison chart created');
        }
        
        // ========== 3-DAY FORECAST SYSTEM ==========
        
        // Store historical data (simulating 3 days of data)
        function saveHistoricalData() {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            if (cities.length === 0) return;
            
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            let historicalData = JSON.parse(localStorage.getItem('historicalData')) || {};
            
            // Initialize if doesn't exist
            if (!historicalData[today]) {
                historicalData[today] = {};
            }
            
            // Save today's data for each city
            cities.forEach(city => {
                if (!historicalData[today][city.name]) {
                    historicalData[today][city.name] = {
                        aqi: city.aqi,
                        pm25: city.pm25,
                        pm10: city.pm10,
                        no2: city.no2,
                        timestamp: new Date().toISOString()
                    };
                }
            });
            
            // Keep only last 3 days of data
            const dates = Object.keys(historicalData).sort();
            if (dates.length > 3) {
                dates.slice(0, dates.length - 3).forEach(date => {
                    delete historicalData[date];
                });
            }
            
            localStorage.setItem('historicalData', JSON.stringify(historicalData));
        }
        
        // Generate forecast data (prediction for next 3 days)
        function generateForecastData(cityName) {
            const historicalData = JSON.parse(localStorage.getItem('historicalData')) || {};
            const dates = Object.keys(historicalData).sort();
            
            // Get historical values for this city
            const historicalValues = dates
                .map(date => historicalData[date][cityName])
                .filter(data => data); // Filter out undefined
            
            if (historicalValues.length === 0) {
                // No historical data, use current values
                const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
                const city = cities.find(c => c.name === cityName);
                if (!city) return null;
                
                return {
                    day1: { aqi: city.aqi, pm25: city.pm25, trend: 'stable' },
                    day2: { aqi: city.aqi + 5, pm25: city.pm25 + 2, trend: 'increasing' },
                    day3: { aqi: city.aqi + 10, pm25: city.pm25 + 5, trend: 'increasing' }
                };
            }
            
            // Calculate trend from historical data
            const lastValue = historicalValues[historicalValues.length - 1];
            const avgChange = historicalValues.length > 1 
                ? (lastValue.aqi - historicalValues[0].aqi) / historicalValues.length
                : 0;
            
            // Generate predictions with some randomness
            const day1 = {
                aqi: Math.round(lastValue.aqi + avgChange + (Math.random() * 10 - 5)),
                pm25: Math.round(lastValue.pm25 + (avgChange * 0.3) + (Math.random() * 5 - 2.5)),
                trend: avgChange > 5 ? 'increasing' : avgChange < -5 ? 'decreasing' : 'stable'
            };
            
            const day2 = {
                aqi: Math.round(day1.aqi + avgChange + (Math.random() * 10 - 5)),
                pm25: Math.round(day1.pm25 + (avgChange * 0.3) + (Math.random() * 5 - 2.5)),
                trend: avgChange > 5 ? 'increasing' : avgChange < -5 ? 'decreasing' : 'stable'
            };
            
            const day3 = {
                aqi: Math.round(day2.aqi + avgChange + (Math.random() * 10 - 5)),
                pm25: Math.round(day2.pm25 + (avgChange * 0.3) + (Math.random() * 5 - 2.5)),
                trend: avgChange > 5 ? 'increasing' : avgChange < -5 ? 'decreasing' : 'stable'
            };
            
            return { day1, day2, day3 };
        }
        
        // Initialize 3-day forecast
        let forecastChartInstance = null;
        
        function initializeForecast() {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            if (cities.length === 0) {
                document.getElementById('forecastContainer').innerHTML = 
                    '<div class="col-12"><p class="text-muted text-center">Add cities to see forecast</p></div>';
                return;
            }
            
            // Save current data to historical
            saveHistoricalData();
            
            // Show forecast for first tracked city
            const primaryCity = cities[0];
            displayCityForecast(primaryCity.name);
        }
        
        // Display forecast for a specific city
        function displayCityForecast(cityName) {
            const cities = JSON.parse(localStorage.getItem('trackedCities')) || [];
            const city = cities.find(c => c.name === cityName);
            if (!city) return;
            
            const forecast = generateForecastData(cityName);
            if (!forecast) return;
            
            // Create forecast cards
            const forecastContainer = document.getElementById('forecastContainer');
            const today = new Date();
            
            const forecastHTML = `
                <div class="col-12 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 style="color: #4B0082; font-weight: 700;">${cityName} - 3-Day Forecast</h5>
                        <select id="forecastCitySelect" class="form-select" style="width: auto;" onchange="displayCityForecast(this.value)">
                            ${cities.map(c => `<option value="${c.name}" ${c.name === cityName ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="forecast-card">
                        <div class="forecast-day">${new Date(today.getTime() + 24*60*60*1000).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>
                        <div class="forecast-aqi" style="color: ${forecast.day1.aqi > 150 ? '#e74c3c' : forecast.day1.aqi > 100 ? '#f39c12' : '#27ae60'}">
                            ${forecast.day1.aqi}
                        </div>
                        <div class="forecast-label">AQI</div>
                        <div class="forecast-pollutant">PM2.5: ${forecast.day1.pm25} µg/m³</div>
                        <div class="forecast-trend ${forecast.day1.trend}">
                            ${forecast.day1.trend === 'increasing' ? '↗️ Increasing' : forecast.day1.trend === 'decreasing' ? '↘️ Decreasing' : '→ Stable'}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="forecast-card">
                        <div class="forecast-day">${new Date(today.getTime() + 2*24*60*60*1000).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>
                        <div class="forecast-aqi" style="color: ${forecast.day2.aqi > 150 ? '#e74c3c' : forecast.day2.aqi > 100 ? '#f39c12' : '#27ae60'}">
                            ${forecast.day2.aqi}
                        </div>
                        <div class="forecast-label">AQI</div>
                        <div class="forecast-pollutant">PM2.5: ${forecast.day2.pm25} µg/m³</div>
                        <div class="forecast-trend ${forecast.day2.trend}">
                            ${forecast.day2.trend === 'increasing' ? '↗️ Increasing' : forecast.day2.trend === 'decreasing' ? '↘️ Decreasing' : '→ Stable'}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="forecast-card">
                        <div class="forecast-day">${new Date(today.getTime() + 3*24*60*60*1000).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</div>
                        <div class="forecast-aqi" style="color: ${forecast.day3.aqi > 150 ? '#e74c3c' : forecast.day3.aqi > 100 ? '#f39c12' : '#27ae60'}">
                            ${forecast.day3.aqi}
                        </div>
                        <div class="forecast-label">AQI</div>
                        <div class="forecast-pollutant">PM2.5: ${forecast.day3.pm25} µg/m³</div>
                        <div class="forecast-trend ${forecast.day3.trend}">
                            ${forecast.day3.trend === 'increasing' ? '↗️ Increasing' : forecast.day3.trend === 'decreasing' ? '↘️ Decreasing' : '→ Stable'}
                        </div>
                    </div>
                </div>
            `;
            
            forecastContainer.innerHTML = forecastHTML;
            
            // Create stock market style chart
            createForecastChart(cityName, city, forecast);
        }
        
        // Create stock market style line chart
        function createForecastChart(cityName, currentCity, forecast) {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (forecastChartInstance) {
                forecastChartInstance.destroy();
            }
            
            // Get historical data
            const historicalData = JSON.parse(localStorage.getItem('historicalData')) || {};
            const dates = Object.keys(historicalData).sort();
            
            // Build historical values
            const historicalLabels = [];
            const historicalAQI = [];
            const historicalPM25 = [];
            
            dates.forEach(date => {
                if (historicalData[date][cityName]) {
                    historicalLabels.push(new Date(date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
                    historicalAQI.push(historicalData[date][cityName].aqi);
                    historicalPM25.push(historicalData[date][cityName].pm25);
                }
            });
            
            // Add current day
            historicalLabels.push('Today');
            historicalAQI.push(currentCity.aqi);
            historicalPM25.push(currentCity.pm25);
            
            // Add forecast days
            const today = new Date();
            historicalLabels.push(new Date(today.getTime() + 24*60*60*1000).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            historicalLabels.push(new Date(today.getTime() + 2*24*60*60*1000).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            historicalLabels.push(new Date(today.getTime() + 3*24*60*60*1000).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            
            // Split into historical and forecast
            const historicalLength = historicalAQI.length;
            const forecastAQI = [currentCity.aqi, forecast.day1.aqi, forecast.day2.aqi, forecast.day3.aqi];
            const forecastPM25 = [currentCity.pm25, forecast.day1.pm25, forecast.day2.pm25, forecast.day3.pm25];
            
            forecastChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: historicalLabels,
                    datasets: [{
                        label: 'Historical AQI',
                        data: [...historicalAQI, null, null, null],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgb(75, 192, 192)'
                    }, {
                        label: 'Forecast AQI',
                        data: [...Array(historicalLength - 1).fill(null), ...forecastAQI],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointStyle: 'circle'
                    }, {
                        label: 'Historical PM2.5',
                        data: [...historicalPM25, null, null, null],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        hidden: false
                    }, {
                        label: 'Forecast PM2.5',
                        data: [...Array(historicalLength - 1).fill(null), ...forecastPM25],
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.05)',
                        borderWidth: 2,
                        borderDash: [5, 3],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        hidden: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: `${cityName} - Air Quality Trend & Forecast`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + (label.includes('AQI') ? '' : ' µg/m³');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            console.log('✅ Forecast chart created');
        }
        
        // Update user tracked cities count
        function updateUserTrackedCitiesCount(count) {
            const countElement = document.getElementById('userTrackedCitiesCount');
            const textElement = document.getElementById('cityText');
            
            if (countElement) {
                countElement.textContent = count;
                if (textElement) {
                    textElement.textContent = count === 1 ? 'city' : 'cities';
                }
            }
        }
        
        // Fetch total cities count from database
        async function fetchTotalCitiesCount() {
            const countElement = document.getElementById('totalCitiesCount');
            
            try {
                // First try to use the imported cities data
                const cities = citiesData.length > 0 ? citiesData : window.indianCitiesData || [];
                
                if (cities.length > 0) {
                    countElement.innerHTML = `<strong>${cities.length}</strong>`;
                    return;
                }
                
                // Fallback to API if cities data not loaded
                const response = await fetch('/api/pollution/cities');
                if (response.ok) {
                    const data = await response.json();
                    const totalCities = data.length || 0;
                    countElement.innerHTML = `<strong>${totalCities}</strong>`;
                } else {
                    // Fallback if API fails
                    countElement.innerHTML = '<strong>50</strong>';
                }
            } catch (error) {
                console.error('Error fetching total cities count:', error);
                // Fallback value from cities.js
                countElement.innerHTML = '<strong>50</strong>';
            }
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch and display total cities count from database
            fetchTotalCitiesCount();
            
            // Update total cities count every 5 minutes
            setInterval(fetchTotalCitiesCount, 300000);
            
            // Initialize map when map tab is shown
            document.getElementById('map-tab').addEventListener('shown.bs.tab', function() {
                setTimeout(function() {
                    initMap();
                }, 300);
            });
            
            // Also trigger map initialization on click
            document.getElementById('map-tab').addEventListener('click', function() {
                setTimeout(function() {
                    initMap();
                }, 300);
            });
            
            // Initialize analysis charts when analysis tab is shown
            document.getElementById('analysis-tab').addEventListener('shown.bs.tab', function() {
                // Populate city selector for single city analysis
                populateCitySelectors();
            });
            
            document.getElementById('overall-tab').addEventListener('shown.bs.tab', function() {
                // Reinitialize every time tab is shown to get latest city data
                initializeAnalysisCharts();
                initializeForecast();
            });
            
            // Display tracked cities
            displayTrackedCities();
            
            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                
                // Update icon
                if (isDarkMode) {
                    darkModeToggle.innerHTML = '<i class="bi bi-sun"></i>';
                } else {
                    darkModeToggle.innerHTML = '<i class="bi bi-moon-stars"></i>';
                }
            });
            
            // Check for saved dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="bi bi-sun"></i>';
            }
        });
    </script>
</body>
</html>
